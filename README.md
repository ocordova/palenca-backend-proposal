# Proposal of API project (WIP)

The goal of this project architecture is to overcome Palenca's main development pain points


## Requirements
- [Docker](https://www.docker.com/get-started)
- [pre-commit](https://pre-commit.com)

## Steps to run the project

```bash
docker build -t palenca_api -f Dockerfile.development .
docker run -it -v "$(pwd)":/opt/api:cached -p 9000:9000 palenca_api /bin/bash -l
python -m api.app
```

## Run tests

```bash
docker exec -it CONTAINER_ID /bin/bash -l
pytest -n auto --timeout=5

```

## Run coverage

```bash
docker exec -it CONTAINER_ID /bin/bash -l
pytest --cov-report term-missing --cov=api

```


## Migrations ([Aerich](https://github.com/tortoise/aerich))

Run migrations
```bash
aerich upgrade
```

Create migration
```bash
aerich migrate --name create_app_login_table
```

Downgrade

```bash
aerich downgrade
```

## Code Formatting
To maintain the same style throughout the code, we use the following tools:
- [Black](https://github.com/psf/black): Code formatter
- [Autoflake](https://github.com/PyCQA/autoflake): Removes unused imports and variables
- [Mypy](https://github.com/python/mypy): Static type checker

To ensure this, we use [pre-commit](https://pre-commit.com/) to run as git hook. Follow [pre-commit installation instructions](https://pre-commit.com/#install) for your development environment

## Project Structure
```markdown
requirements         # Project requirements. See section below
migrations           # Migration files generated by Aerich
api                  # Clean architecture project. See section below
   |-- app.py        # Main application start point
   |-- data          # Models, Repositories, Fakers
   |-- domain        # Entities, enums, adapters, usecases
   |-- misc          # Config and utils
   |-- presentation  # Resources, response models and validations
```

## Requirements
### Base
- [FastAPI](https://fastapi.tiangolo.com/): Web framwork for the API endpoints, OpenAPI Documentation and Request validation
- [Tortoise ORM](https://tortoise-orm.readthedocs.io/en/latest/): asyncio ORM for Postgres
- [Aerich](https://github.com/tortoise/aerich): Migration tool for Tortoise ORM
- [cuid](https://github.com/ericelliott/cuid): Collision-resistant ids
- [bcrypt](https://github.com/pyca/bcrypt/): Password hashing tool

### Testing
- [pytest](https://docs.pytest.org/): Framework for testing
- [Hypothesis](https://hypothesis.works/): Framework used by some test to generate test data
- [Factory boy](https://factoryboy.readthedocs.io/en/stable/): Fixtures replacement tool for Tortoise Models

## Environment variables
The project needs environment variables to be set, to run correctly. See `misc/config.py` for a list of them.
You can set them inside the Dockerfiles


## Open API
FastAPI autogenerates the [OpenAPI Specification](https://www.openapis.org/).
Once you run the project, you can view them with Swagger UI and ReDoc:
```
Swagger: http://localhost:9000/docs
ReDoc: http://localhost:9000/redoc
```


## Clean Architecture√ß

This project is following the [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)  software design philosophy.

![](docs/clean_architecture.jpg?raw=true)


## Modules
### Entities
`domain/entities`<br>
Entities are native business objects of this project. In this project, examples are Client, User, Platform, AppLogin. An entity is typically saved to the database using a repository method (see below), but it can also have been fetched from other apis using HTTP.

`domain/enums`<br>
We use enums to guarantee the uniqueness of constant values
### Adapters
`domain/adapters`<br>
The adapters are functions that convert a database model or third party api model to an entity.

### Repositories
`data/repositories`<br>
The functions receive entities and change the database in a specific way or connect with an api to retrieve information. The functions that return entities typically have to use an adapter to convert the model instance to an entity. In this way, the database or third party api is abstracted from the business logic.

### Use cases
`domain/usecases`<br>
The use cases contains the actual business logic. For example, what to do if someone logins to a platform? The use case checks the platform is online, that the platform is available in the country, notify to socket or webhooks.

The use cases typically call repository methods.

### Exceptions
`domain/exceptions`<br>
Exceptions that are typically raised by use cases. They can be converted to JSON, and returned to the HTTP client and typically include a link to the documentation.

### Resources
`presentation/resources`<br>
Are built using FastAPI dependency. They use validations to parse HTTP requests data. They call the use cases. They also check the authentication, encode the Exceptions into JSON an serialize the responses and can detect the api version to call a specific usecase or return a different response schema.

### Validations
`presentation/validations`<br>
Endpoint payload validation are build using pydantic library, they are used by FastAPI to parse and validate the data. A lot of schemata corresponds to an entity or enum.

### Responses
`presentation/reponses`<br>
Endpoint JSON response are build using the pydantic library, they are used by FastAPI to serialize them.

